CREATE DATABASE ProyectBD;
USE basedatodo;
CREATE TABLE Carta(
    IDCarta VARCHAR(50) PRIMARY KEY,
    Palo varchar(20),
    Numero int,
    Imagen varchar(255)
);
CREATE TABLE Usuario(
    IDUsuario int PRIMARY KEY,
    Nombre varchar(50),
    Tipo ENUM('administrador', 'jugador')
);
CREATE TABLE Partida(
    IDPartida int PRIMARY KEY,
    hora TIME,
    fecha DATE,
    estado ENUM('suspendido', 'finalizado')
);
CREATE TABLE Mano(
    IDMano int PRIMARY KEY,
    IDUsuario int,
    IDPartida int,
    FOREIGN KEY (IDUsuario) REFERENCES Usuario(IDUsuario),
    FOREIGN KEY (IDPartida) REFERENCES Partida(IDPartida)
);
CREATE TABLE Juegan(
    IDUsuario int,
    IDPartida int,
    PRIMARY KEY (IDUsuario, IDPartida),
    FOREIGN KEY (IDUsuario) REFERENCES Usuario(IDUsuario),
    FOREIGN KEY (IDPartida) REFERENCES Partida(IDPartida)
);
CREATE TABLE Compone(
    IDMano INT,
    IDCarta VARCHAR(50),
    PRIMARY KEY (IDMano, IDCarta),
    FOREIGN KEY (IDMano) REFERENCES Mano(IDMano),
    FOREIGN KEY (IDCarta) REFERENCES Carta(IDCarta)
);

-- Procedimiento Mano

DELIMITER //
CREATE PROCEDURE insertarMano(
IN m_IDUsuario INT,
IN m_IDPartida INT,
OUT m_IdMano INT
)
BEGIN
DECLARE m_IdMano INT;
INSERT INTO mano(IDUsuario, IDPartida)
VALUES(m_IDUsuario, m_Partida);
SET m_IdMano= LAST_INSERT_ID();
END//
DELIMITER ;

-- Procedimiento Tabla Compone

DELIMITER //
CREATE PROCEDURE insertarCartas(
IN m_IdMano INT,
IN m_IdCarta VARCHAR(50)
)
BEGIN
INSERT INTO Compone(IDMano, IDCarta)
VALUES(m_IdMano, m_IdCarta);
END//
DELIMITER ;

-- Procedimiento para Partida

DELIMITER //
CREATE PROCEDURE guardarPartida(
IN m_Hora VARCHAR(50),
IN m_Fecha DATE,
IN m_Estado VARCHAR(50)
IN m_IDUsuario INT,
IN n_IDUsuario INT
)
BEGIN
DECLARE p_IdMano;
OUT p_IdMano;
DECLARE s_IdMano;
OUT s_IdMano;
DECLARE m_IDPartida;
INSERT INTO Partida(hora, fecha, estado)
VALUES(m_Hora, m_Fecha, m_Estado);
SET m_IDPartida = LAST_INSERT_ID();
INSERT INTO Juegan(IDUsuario, IDPartida)
VALUES(m_IDUsuario, m_IDPartida);
INSERT INTO Juegan(IDUsuario, IDPartida)
VALUES(n_IDUsuario, m_IDPartida);
CALL insertarMano(m_IDUsuario, m_IDPartida, p_IdMano);
CALL insertarMano(n_IDUsuario, m_IDPartida, s_IdMano);
END//
DELIMITER ;